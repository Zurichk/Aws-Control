{% extends "base.html" %}

{% block title %}Crear Registro DNS - {{ zone_name }} - Route 53{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title mb-0">Crear Registro DNS</h2>
                    <small class="text-muted">Zona: {{ zone_name }} ({{ zone_id }})</small>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="name" class="form-label">Nombre del Registro <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="name" name="name" required
                                               placeholder="www, api, mail, etc.">
                                        <span class="input-group-text">.{{ zone_name }}</span>
                                    </div>
                                    <div class="form-text">
                                        Nombre del subdominio (deja vacío para el dominio raíz). Ejemplo: "www" para www.ejemplo.com
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="type" class="form-label">Tipo de Registro <span class="text-danger">*</span></label>
                                    <select class="form-select" id="type" name="type" required>
                                        <option value="">Seleccionar tipo...</option>
                                        <option value="A">A - Dirección IPv4</option>
                                        <option value="AAAA">AAAA - Dirección IPv6</option>
                                        <option value="CNAME">CNAME - Alias canónico</option>
                                        <option value="MX">MX - Correo electrónico</option>
                                        <option value="TXT">TXT - Texto</option>
                                        <option value="SRV">SRV - Servicio</option>
                                        <option value="PTR">PTR - Puntero</option>
                                        <option value="NS">NS - Servidor de nombres</option>
                                        <option value="SOA">SOA - Inicio de autoridad</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="value" class="form-label">Valor <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="value" name="value" rows="3" required
                                              placeholder="Valor del registro DNS"></textarea>
                                    <div class="form-text" id="value_help">
                                        Introduce el valor correspondiente al tipo de registro seleccionado.
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="ttl" class="form-label">TTL (Time To Live)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="ttl" name="ttl" min="0" max="2147483647" value="300">
                                        <span class="input-group-text">segundos</span>
                                    </div>
                                    <div class="form-text">
                                        Tiempo en segundos que los resolvers DNS cachean este registro. Valor por defecto: 300 (5 minutos).
                                    </div>
                                </div>

                                <div class="mb-3" id="priority_section" style="display: none;">
                                    <label for="priority" class="form-label">Prioridad (solo para MX)</label>
                                    <input type="number" class="form-control" id="priority" name="priority" min="0" max="65535" placeholder="10">
                                    <div class="form-text">Prioridad del servidor de correo (0 = más alta prioridad).</div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Tipos de Registros DNS</h5>
                                    </div>
                                    <div class="card-body">
                                        <dl class="small">
                                            <dt>A</dt>
                                            <dd>Asocia un nombre a una dirección IPv4</dd>

                                            <dt>AAAA</dt>
                                            <dd>Asocia un nombre a una dirección IPv6</dd>

                                            <dt>CNAME</dt>
                                            <dd>Crea un alias para otro nombre de dominio</dd>

                                            <dt>MX</dt>
                                            <dd>Especifica servidores de correo electrónico</dd>

                                            <dt>TXT</dt>
                                            <dd>Almacena texto arbitrario (SPF, DKIM, etc.)</dd>
                                        </dl>

                                        <div class="alert alert-info small">
                                            <strong>Nota:</strong> Los registros NS y SOA son administrados automáticamente por Route 53.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{{ url_for('route53.list_records', zone_id=zone_id) }}" class="btn btn-secondary">Cancelar</a>
                                    <button type="submit" class="btn btn-success">Crear Registro DNS</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Actualizar ayuda del valor según el tipo seleccionado
document.getElementById('type').addEventListener('change', function() {
    const type = this.value;
    const valueHelp = document.getElementById('value_help');
    const prioritySection = document.getElementById('priority_section');
    const valueTextarea = document.getElementById('value');

    // Reset
    prioritySection.style.display = 'none';
    valueTextarea.placeholder = 'Valor del registro DNS';

    switch(type) {
        case 'A':
            valueHelp.textContent = 'Introduce una dirección IPv4 válida (ejemplo: 192.168.1.1)';
            valueTextarea.placeholder = '192.168.1.1';
            break;
        case 'AAAA':
            valueHelp.textContent = 'Introduce una dirección IPv6 válida (ejemplo: 2001:db8::1)';
            valueTextarea.placeholder = '2001:db8::1';
            break;
        case 'CNAME':
            valueHelp.textContent = 'Introduce el nombre canónico completo (ejemplo: www.ejemplo.com)';
            valueTextarea.placeholder = 'www.ejemplo.com';
            break;
        case 'MX':
            valueHelp.textContent = 'Introduce el servidor de correo con prioridad (ejemplo: 10 mail.ejemplo.com)';
            valueTextarea.placeholder = '10 mail.ejemplo.com';
            prioritySection.style.display = 'block';
            break;
        case 'TXT':
            valueHelp.textContent = 'Introduce el texto (ejemplo: "v=spf1 -all" para SPF)';
            valueTextarea.placeholder = '"v=spf1 -all"';
            break;
        case 'SRV':
            valueHelp.textContent = 'Formato: prioridad peso puerto objetivo (ejemplo: 0 5 5060 sip.ejemplo.com)';
            valueTextarea.placeholder = '0 5 5060 sip.ejemplo.com';
            break;
        default:
            valueHelp.textContent = 'Introduce el valor correspondiente al tipo de registro seleccionado.';
    }
});

// Validación del formulario
document.querySelector('form').addEventListener('submit', function(e) {
    const type = document.getElementById('type').value;
    const value = document.getElementById('value').value.trim();

    if (!type) {
        alert('Por favor selecciona un tipo de registro.');
        e.preventDefault();
        return;
    }

    if (!value) {
        alert('Por favor introduce un valor para el registro.');
        e.preventDefault();
        return;
    }

    // Validaciones específicas por tipo
    switch(type) {
        case 'A':
            const ipv4Regex = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (!ipv4Regex.test(value)) {
                alert('La dirección IPv4 no tiene un formato válido.');
                e.preventDefault();
                return;
            }
            break;
        case 'AAAA':
            // Validación básica de IPv6
            if (!value.includes(':') || value.split(':').length < 3) {
                alert('La dirección IPv6 no tiene un formato válido.');
                e.preventDefault();
                return;
            }
            break;
    }
});
</script>
{% endblock %}