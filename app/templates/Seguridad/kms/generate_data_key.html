{% extends "base.html" %}

{% block title %}AWS Control Panel - Generar Clave de Datos{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <i class="fas fa-random text-secondary me-2"></i>
                            <h5 class="mb-0 d-inline">Generar Clave de Datos</h5>
                            <small class="text-muted ms-2">Clave: {{ key_id }}</small>
                        </div>
                        <a href="{{ url_for('kms.index') }}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Volver
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                                    <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} me-2"></i>
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>¿Qué es una Clave de Datos?</strong>
                        Una clave de datos es una clave de encriptación que puedes usar para encriptar datos localmente.
                        La clave de datos en sí está encriptada con tu clave KMS, permitiendo "envelope encryption" para datos grandes.
                    </div>

                    <div class="row">
                        <div class="col-lg-6">
                            <form method="POST" action="{{ url_for('kms.generate_data_key', key_id=key_id) }}">
                                <div class="mb-3">
                                    <label for="key_length" class="form-label">
                                        <i class="fas fa-ruler me-2"></i>
                                        Longitud de la Clave de Datos
                                    </label>
                                    <select class="form-select" id="key_length" name="key_length">
                                        <option value="128" selected>128 bits (16 bytes)</option>
                                        <option value="256">256 bits (32 bytes) - Recomendado</option>
                                    </select>
                                    <div class="form-text">
                                        Longitud de la clave de datos que se generará. 256 bits es más seguro.
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="encoding" class="form-label">
                                        <i class="fas fa-code me-2"></i>
                                        Formato de Salida
                                    </label>
                                    <select class="form-select" id="encoding" name="encoding">
                                        <option value="base64" selected>Base64 (recomendado)</option>
                                        <option value="hex">Hexadecimal</option>
                                        <option value="raw">Raw (bytes)</option>
                                    </select>
                                    <div class="form-text">Formato para mostrar las claves generadas.</div>
                                </div>

                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="include_plaintext" name="include_plaintext" checked>
                                        <label class="form-check-label" for="include_plaintext">
                                            <i class="fas fa-eye me-2"></i>
                                            Incluir Clave de Datos en Texto Plano
                                        </label>
                                    </div>
                                    <div class="form-text">
                                        Si se marca, se incluye la clave de datos sin encriptar (para uso inmediato).
                                        <strong class="text-warning">¡Guárdala de forma segura!</strong>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="add_context" name="add_context">
                                        <label class="form-check-label" for="add_context">
                                            <i class="fas fa-plus me-2"></i>
                                            Agregar Contexto de Encriptación
                                        </label>
                                    </div>
                                    <div class="form-text">Proporciona contexto adicional para mayor seguridad (opcional).</div>
                                </div>

                                <div id="context_fields" class="mb-3" style="display: none;">
                                    <div class="mb-2">
                                        <strong>Contexto de Encriptación</strong>
                                    </div>
                                    <div id="context_entries">
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" name="context_key_1" placeholder="Clave (ej: user_id)">
                                            <input type="text" class="form-control" name="context_value_1" placeholder="Valor (ej: 12345)">
                                            <button type="button" class="btn btn-outline-danger remove-context">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="add_context_entry">
                                        <i class="fas fa-plus me-2"></i>Agregar Campo
                                    </button>
                                </div>

                                <button type="submit" class="btn btn-secondary">
                                    <i class="fas fa-random me-2"></i>Generar Clave de Datos
                                </button>
                            </form>
                        </div>

                        <div class="col-lg-6">
                            <div class="card bg-light">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Información de la Clave
                                    </h6>
                                </div>
                                <div class="card-body">
                                    {% if key_info %}
                                        <dl class="row">
                                            <dt class="col-sm-4">ID de Clave:</dt>
                                            <dd class="col-sm-8">
                                                <code class="small">{{ key_info.key_id }}</code>
                                            </dd>

                                            <dt class="col-sm-4">Estado:</dt>
                                            <dd class="col-sm-8">
                                                {% if key_info.key_state == 'Enabled' %}
                                                    <span class="badge bg-success">Habilitada</span>
                                                {% elif key_info.key_state == 'Disabled' %}
                                                    <span class="badge bg-warning">Deshabilitada</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ key_info.key_state }}</span>
                                                {% endif %}
                                            </dd>

                                            <dt class="col-sm-4">Uso:</dt>
                                            <dd class="col-sm-8">{{ key_info.key_usage }}</dd>

                                            <dt class="col-sm-4">Especificación:</dt>
                                            <dd class="col-sm-8">{{ key_info.key_spec }}</dd>

                                            {% if key_info.description %}
                                                <dt class="col-sm-4">Descripción:</dt>
                                                <dd class="col-sm-8">{{ key_info.description }}</dd>
                                            {% endif %}

                                            {% if key_info.aliases %}
                                                <dt class="col-sm-4">Aliases:</dt>
                                                <dd class="col-sm-8">
                                                    {% for alias in key_info.aliases %}
                                                        <span class="badge bg-info me-1">{{ alias }}</span>
                                                    {% endfor %}
                                                </dd>
                                            {% endif %}
                                        </dl>
                                    {% else %}
                                        <div class="text-center text-muted">
                                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                            <p>No se pudo cargar la información de la clave.</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="card mt-3">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-lightbulb me-2"></i>
                                        Casos de Uso
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled">
                                        <li class="mb-2">
                                            <i class="fas fa-file-archive text-primary me-2"></i>
                                            <strong>Archivos Grandes:</strong> Encriptar archivos >4KB que no pueden usar KMS directamente.
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-database text-success me-2"></i>
                                            <strong>Bases de Datos:</strong> Encriptar datos antes de almacenarlos en BD.
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-cloud text-info me-2"></i>
                                            <strong>Almacenamiento:</strong> Encriptar objetos antes de subirlos a S3.
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-shield-alt text-warning me-2"></i>
                                            <strong>Envelope Encryption:</strong> Doble capa de seguridad.
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if data_key %}
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card border-secondary">
                                    <div class="card-header bg-secondary text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-key me-2"></i>
                                            Clave de Datos Generada Exitosamente
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        {% if data_key.plaintext %}
                                            <div class="mb-3">
                                                <div class="mb-2">
                                                    <strong>Clave de Datos (Texto Plano - {{ data_key.encoding }})</strong>
                                                </div>
                                                <div class="input-group">
                                                    <textarea class="form-control font-monospace small" rows="3" readonly
                                                              id="plaintextKey">{{ data_key.plaintext }}</textarea>
                                                    <button class="btn btn-outline-secondary" type="button" onclick="copyPlaintextKey()">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </div>
                                                <div class="alert alert-warning mt-2">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                                    <strong>¡Importante!</strong> Esta es la clave que usarás para encriptar tus datos.
                                                    Guárdala de forma segura y no la compartas.
                                                </div>
                                            </div>
                                        {% endif %}

                                        <div class="mb-3">
                                            <div class="mb-2">
                                                <strong>Clave de Datos Encriptada ({{ data_key.encoding }})</strong>
                                            </div>
                                            <div class="input-group">
                                                <textarea class="form-control font-monospace small" rows="4" readonly
                                                          id="encryptedKey">{{ data_key.ciphertext_blob }}</textarea>
                                                <button class="btn btn-outline-secondary" type="button" onclick="copyEncryptedKey()">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                            <div class="form-text">
                                                Esta versión encriptada es segura para almacenar. Úsala para desencriptar la clave cuando la necesites.
                                            </div>
                                        </div>

                                        {% if data_key.key_id %}
                                            <div class="mb-3">
                                                <div class="mb-2">
                                                    <strong>ID de Clave KMS Usada:</strong>
                                                </div>
                                                <code class="small">{{ data_key.key_id }}</code>
                                            </div>
                                        {% endif %}

                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>Flujo de Trabajo Recomendado:</strong>
                                            <ol class="mb-0 mt-2">
                                                <li>Usa la clave de datos (texto plano) para encriptar tus datos localmente</li>
                                                <li>Almacena los datos encriptados junto con la clave encriptada</li>
                                                <li>Cuando necesites los datos, usa KMS para desencriptar la clave de datos</li>
                                                <li>Usa la clave de datos desencriptada para desencriptar tus datos originales</li>
                                            </ol>
                                        </div>

                                        <div class="d-flex gap-2">
                                            <button type="button" class="btn btn-outline-secondary" onclick="clearResults()">
                                                <i class="fas fa-trash me-2"></i>Limpiar Resultados
                                            </button>
                                            <button type="button" class="btn btn-outline-primary" onclick="generateAnother()">
                                                <i class="fas fa-random me-2"></i>Generar Otra
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('add_context').addEventListener('change', function() {
    const contextFields = document.getElementById('context_fields');
    contextFields.style.display = this.checked ? 'block' : 'none';
});

let contextEntryCount = 1;

document.getElementById('add_context_entry').addEventListener('click', function() {
    contextEntryCount++;
    const contextEntries = document.getElementById('context_entries');

    const newEntry = document.createElement('div');
    newEntry.className = 'input-group mb-2';
    newEntry.innerHTML = `
        <input type="text" class="form-control" name="context_key_${contextEntryCount}" placeholder="Clave (ej: user_id)">
        <input type="text" class="form-control" name="context_value_${contextEntryCount}" placeholder="Valor (ej: 12345)">
        <button type="button" class="btn btn-outline-danger remove-context">
            <i class="fas fa-minus"></i>
        </button>
    `;

    contextEntries.appendChild(newEntry);

    // Agregar event listener al nuevo botón de eliminar
    newEntry.querySelector('.remove-context').addEventListener('click', function() {
        newEntry.closest('.input-group').remove();
    });
});

// Agregar event listener a los botones de eliminar existentes
document.querySelectorAll('.remove-context').forEach(button => {
    button.addEventListener('click', function() {
        this.closest('.input-group').remove();
    });
});

function copyPlaintextKey() {
    const textarea = document.getElementById('plaintextKey');
    if (textarea) {
        textarea.select();
        document.execCommand('copy');

        // Mostrar feedback visual
        const button = textarea.nextElementSibling;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i>';
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-success');

        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
    }
}

function copyEncryptedKey() {
    const textarea = document.getElementById('encryptedKey');
    textarea.select();
    document.execCommand('copy');

    // Mostrar feedback visual
    const button = textarea.nextElementSibling;
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i>';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-success');

    setTimeout(() => {
        button.innerHTML = originalHTML;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
    }, 2000);
}

function clearResults() {
    const resultsCard = document.querySelector('.border-secondary');
    if (resultsCard) {
        resultsCard.remove();
    }
}

function generateAnother() {
    clearResults();
    // Scroll to top of form
    document.querySelector('form').scrollIntoView({ behavior: 'smooth' });
}
</script>

{% endblock %}