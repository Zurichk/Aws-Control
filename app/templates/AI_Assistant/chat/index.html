{% extends "base.html" %}

{% block title %}AWS Control Panel - AI Assistant{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-robot text-primary me-2"></i>
                        AI Assistant
                    </h1>
                    <p class="text-muted mt-1">Tu gu√≠a experto en AWS - obt√©n ayuda y consejos personalizados</p>
                </div>
                <div>
                    <button class="btn btn-outline-primary" onclick="clearChat()">
                        <i class="fas fa-trash me-2"></i>Limpiar Chat
                    </button>
                </div>
            </div>

            <!-- AI Assistant Description -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-brain text-info me-2"></i>¬øC√≥mo puedo ayudarte?
                    </h5>
                    <p class="card-text">
                        Soy tu asistente de IA especializado en AWS. Puedo guiarte paso a paso para completar tareas espec√≠ficas,
                        explicarte conceptos de AWS, recomendar servicios apropiados para tus necesidades, y ayudarte a navegar
                        por este panel de control educativo.
                    </p>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="fas fa-route fa-2x text-success mb-2"></i>
                                <h6>Gu√≠as Paso a Paso</h6>
                                <small class="text-muted">Instrucciones detalladas</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="fas fa-lightbulb fa-2x text-warning mb-2"></i>
                                <h6>Recomendaciones</h6>
                                <small class="text-muted">Mejores pr√°cticas</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="fas fa-question-circle fa-2x text-info mb-2"></i>
                                <h6>Respuestas</h6>
                                <small class="text-muted">Preguntas sobre AWS</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="fas fa-compass fa-2x text-primary mb-2"></i>
                                <h6>Navegaci√≥n</h6>
                                <small class="text-muted">Ayuda con el panel</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Available Tools Section -->
            <div class="card mb-4">
                <div class="card-header" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#toolsCollapse">
                    <h5 class="mb-0">
                        <i class="fas fa-tools text-warning me-2"></i>
                        Herramientas AWS Disponibles
                        <i class="fas fa-chevron-down float-end"></i>
                    </h5>
                </div>
                <div id="toolsCollapse" class="collapse">
                    <div class="card-body">
                        <p class="text-muted mb-3">
                            <i class="fas fa-info-circle me-1"></i>
                            El AI Assistant puede ejecutar estas herramientas autom√°ticamente para ayudarte con tus tareas en AWS.
                        </p>
                        <div id="toolsContainer">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="text-muted mt-2">Cargando herramientas disponibles...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Interface with Operations Panel -->
            <div class="row">
                <!-- Main Chat Column -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-comments me-2"></i>Conversaci√≥n con AI Assistant
                            </h5>
                            <button id="clearHistoryBtn" class="btn btn-sm btn-outline-danger" title="Limpiar historial de conversaci√≥n">
                                <i class="fas fa-trash-alt me-1"></i>Nuevo Chat
                            </button>
                        </div>
                        <div class="card-body">
                    <!-- Chat Messages Container -->
                    <div id="chatContainer" class="chat-container mb-3" style="height: 500px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem; background-color: #f8f9fa;">
                        <!-- Welcome Message -->
                        <div class="message ai-message mb-3">
                            <div class="d-flex align-items-start">
                                <div class="avatar ai-avatar me-3">
                                    <i class="fas fa-robot text-primary"></i>
                                </div>
                                <div class="message-content flex-grow-1">
                                    <div class="message-header">
                                        <strong class="text-primary">AI Assistant</strong>
                                        <small class="text-muted ms-2">Ahora</small>
                                    </div>
                                    <div class="message-body mt-2">
                                        ¬°Hola! Soy tu asistente de IA especializado en AWS. Tengo conocimiento completo de todos los servicios disponibles en este panel de control.

                                        <strong>Servicios que conozco:</strong>
                                        <ul class="mt-2">
                                            <li><strong>Computo:</strong> EC2, Lambda, ECS</li>
                                            <li><strong>Almacenamiento:</strong> S3</li>
                                            <li><strong>Base de Datos:</strong> RDS, DynamoDB</li>
                                            <li><strong>Mensajer√≠a:</strong> SNS, SQS</li>
                                            <li><strong>Redes:</strong> VPC, Route 53, ELB, CloudFront, API Gateway</li>
                                            <li><strong>Seguridad:</strong> IAM, KMS</li>
                                            <li><strong>Analytics:</strong> Kinesis</li>
                                            <li><strong>ML/AI:</strong> SageMaker</li>
                                            <li><strong>Gesti√≥n:</strong> CloudFormation, CloudWatch</li>
                                        </ul>

                                        ¬øEn qu√© puedo ayudarte hoy? Puedo guiarte paso a paso para completar tareas, explicar conceptos, o recomendar servicios para tus necesidades.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Message Input -->
                    <div class="input-group">
                        <textarea
                            id="messageInput"
                            class="form-control"
                            placeholder="Escribe tu pregunta sobre AWS o describe qu√© quieres hacer..."
                            rows="3"
                            style="resize: none;"
                        ></textarea>
                        <button class="btn btn-primary" type="button" onclick="sendMessage()" id="sendButton">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>

                    <!-- Quick Suggestions -->
                    <div class="mt-3">
                        <small class="text-muted">Sugerencias r√°pidas:</small>
                        <div class="d-flex flex-wrap gap-2 mt-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="quickQuestion('¬øC√≥mo creo una instancia EC2?')">
                                Crear EC2
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="quickQuestion('¬øQu√© servicio de base de datos usar para mi aplicaci√≥n?')">
                                Elegir Base de Datos
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="quickQuestion('Expl√≠came qu√© es serverless')">
                                ¬øQu√© es Serverless?
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="quickQuestion('¬øC√≥mo configuro un balanceador de carga?')">
                                Configurar Load Balancer
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="quickQuestion('Recomi√©ndame servicios para una aplicaci√≥n web')">
                                Arquitectura Web
                            </button>
                        </div>
                    </div>
                        </div>
                    </div>
                </div>

                <!-- Operations Panel Column -->
                <div class="col-lg-4">
                    <div class="card sticky-top" style="top: 20px;">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-cogs me-2"></i>Pensamiento del AI
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div id="operationsPanel" style="height: 650px; overflow-y: auto;" class="p-3">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-brain fa-3x mb-3"></i>
                                    <p>Las operaciones de AWS aparecer√°n aqu√≠ mientras el AI trabaja...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.chat-container {
    scroll-behavior: smooth;
}

.operation-item {
    border-left: 3px solid #0d6efd;
    padding-left: 15px;
    margin-bottom: 15px;
    animation: slideIn 0.3s ease-out;
}

.operation-item.success {
    border-left-color: #198754;
}

.operation-item.error {
    border-left-color: #dc3545;
}

.operation-item.thinking {
    border-left-color: #ffc107;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.message {
    margin-bottom: 1rem;
}

.avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #e9ecef;
    flex-shrink: 0;
}

.ai-avatar {
    background-color: #e3f2fd;
}

.user-avatar {
    background-color: #f3e5f5;
}

.message-content {
    max-width: calc(100% - 60px);
}

.message-header {
    font-size: 0.875rem;
}

.message-body {
    font-size: 0.95rem;
    line-height: 1.5;
}

.typing-indicator {
    display: none;
    font-style: italic;
    color: #6c757d;
}

.typing-indicator.show {
    display: block;
}

.code-block {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 0.75rem;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    margin: 0.5rem 0;
    overflow-x: auto;
}
</style>

<script>
let chatContainer = document.getElementById('chatContainer');
let messageInput = document.getElementById('messageInput');
let sendButton = document.getElementById('sendButton');

// Cargar herramientas disponibles al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    loadAvailableTools();
});

// Funci√≥n para cargar las herramientas disponibles
function loadAvailableTools() {
    fetch('/chat/get_tools')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                displayTools(data.tools_by_category, data.total_tools);
            } else {
                showToolsError('Error al cargar herramientas: ' + data.error);
            }
        })
        .catch(error => {
            showToolsError('Error de conexi√≥n: ' + error.message);
        });
}

// Funci√≥n para mostrar las herramientas organizadas por categor√≠a
function displayTools(toolsByCategory, totalTools) {
    const container = document.getElementById('toolsContainer');
    
    let html = `
        <div class="alert alert-info mb-3">
            <i class="fas fa-check-circle me-2"></i>
            <strong>${totalTools} herramientas</strong> disponibles para el AI Assistant
        </div>
        <div class="row">
    `;
    
    // Iterar sobre cada categor√≠a
    for (const [category, tools] of Object.entries(toolsByCategory)) {
        html += `
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="fas fa-layer-group text-primary me-2"></i>
                            ${category}
                            <span class="badge bg-primary float-end">${tools.length}</span>
                        </h6>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <div class="list-group list-group-flush">
        `;
        
        // Agregar cada herramienta de la categor√≠a
        tools.forEach(tool => {
            html += `
                <div class="list-group-item px-0 py-2 border-0">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-cog text-muted me-2 mt-1" style="font-size: 0.85rem;"></i>
                        <div class="flex-grow-1">
                            <code class="text-primary" style="font-size: 0.85rem;">${tool.name}</code>
                            <p class="text-muted mb-0 small">${tool.description}</p>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    container.innerHTML = html;
}

// Funci√≥n para mostrar error al cargar herramientas
function showToolsError(message) {
    const container = document.getElementById('toolsContainer');
    container.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
}

// Auto-resize textarea
messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// Send message on Enter (but allow Shift+Enter for new lines)
messageInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

function quickQuestion(question) {
    messageInput.value = question;
    messageInput.style.height = 'auto';
    messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
    sendMessage();
}

function sendMessage() {
    const message = messageInput.value.trim();
    if (!message) return;

    // Add user message to chat
    addMessage(message, 'user');

    // Clear input
    messageInput.value = '';
    messageInput.style.height = 'auto';

    // Show typing indicator
    showTypingIndicator();
    
    // Add thinking operation to panel
    addOperationToPanel('Pensando...', 'El AI est√° analizando tu solicitud', 'thinking');

    // Send to server
    fetch('/chat/send_message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Respuesta recibida:', data);
        hideTypingIndicator();

        if (data.status === 'success') {
            console.log('Status: success');
            console.log('Tool results:', data.tool_results);
            console.log('Response:', data.response);
            
            // Mostrar resultados de herramientas si existen
            if (data.tool_results && data.tool_results.length > 0) {
                for (const toolResult of data.tool_results) {
                    // Agregar al panel de operaciones
                    const toolName = toolResult.tool.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const isSuccess = !toolResult.result.error;
                    const statusType = isSuccess ? 'success' : 'error';
                    
                    let details = '';
                    if (isSuccess && toolResult.result.result) {
                        const result = toolResult.result.result;
                        details = Object.entries(result).slice(0, 3).map(([k, v]) => 
                            `${k}: ${typeof v === 'object' ? JSON.stringify(v).substring(0, 50) + '...' : v}`
                        ).join('<br>');
                    } else if (toolResult.result.error) {
                        details = toolResult.result.error;
                    }
                    
                    addOperationToPanel(
                        `üîß ${toolName}`,
                        details || 'Operaci√≥n completada',
                        statusType
                    );
                    
                    // Agregar tambi√©n al chat principal
                    addToolResultMessage(toolResult);
                }
            }
            
            // Mostrar respuesta del AI
            if (data.response) {
                addOperationToPanel('‚úÖ Respuesta generada', 'El AI ha completado su an√°lisis', 'success');
                addMessage(data.response, 'ai');
            }
        } else {
            addOperationToPanel('‚ùå Error', data.error, 'error');
            addMessage('Lo siento, hubo un error al procesar tu mensaje: ' + data.error, 'ai', true);
        }
    })
    .catch(error => {
        hideTypingIndicator();
        addOperationToPanel('‚ùå Error de conexi√≥n', error.message, 'error');
        addMessage('Error de conexi√≥n. Por favor, verifica tu conexi√≥n a internet e intenta nuevamente.', 'ai', true);
        console.error('Error:', error);
    });
}

function addMessage(content, sender, isError = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;

    const avatarClass = sender === 'ai' ? 'ai-avatar' : 'user-avatar';
    const avatarIcon = sender === 'ai' ? 'fas fa-robot' : 'fas fa-user';
    const avatarColor = sender === 'ai' ? 'text-primary' : 'text-secondary';
    const senderName = sender === 'ai' ? 'AI Assistant' : 'T√∫';

    messageDiv.innerHTML = `
        <div class="d-flex align-items-start">
            <div class="avatar ${avatarClass} me-3">
                <i class="${avatarIcon} ${avatarColor}"></i>
            </div>
            <div class="message-content flex-grow-1">
                <div class="message-header">
                    <strong class="${sender === 'ai' ? 'text-primary' : 'text-secondary'}">${senderName}</strong>
                    <small class="text-muted ms-2">Ahora</small>
                </div>
                <div class="message-body mt-2 ${isError ? 'text-danger' : ''}">
                    ${formatMessage(content)}
                </div>
            </div>
        </div>
    `;

    chatContainer.appendChild(messageDiv);
    scrollToBottom();
}

function addToolResultMessage(toolResult) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ai-message';

    const toolName = toolResult.tool.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    const isSuccess = toolResult.result.success;
    const statusClass = isSuccess ? 'success' : 'danger';
    const statusIcon = isSuccess ? 'check-circle' : 'exclamation-triangle';

    let resultHtml = `
        <div class="alert alert-${statusClass} mb-0">
            <h6 class="alert-heading">
                <i class="fas fa-${statusIcon} me-2"></i>
                <strong>Herramienta Ejecutada:</strong> ${toolName}
            </h6>
            <hr>
    `;

    if (isSuccess && toolResult.result.result) {
        const result = toolResult.result.result;
        resultHtml += '<ul class="mb-0">';
        for (const [key, value] of Object.entries(result)) {
            if (typeof value === 'object' && value !== null) {
                resultHtml += `<li><strong>${key}:</strong> ${JSON.stringify(value, null, 2)}</li>`;
            } else {
                resultHtml += `<li><strong>${key}:</strong> ${value}</li>`;
            }
        }
        resultHtml += '</ul>';
    } else if (toolResult.result.error) {
        resultHtml += `<p class="mb-0"><strong>Error:</strong> ${toolResult.result.error}</p>`;
    }

    resultHtml += '</div>';

    messageDiv.innerHTML = `
        <div class="d-flex align-items-start">
            <div class="avatar ai-avatar me-3">
                <i class="fas fa-cog text-primary"></i>
            </div>
            <div class="message-content flex-grow-1">
                <div class="message-header">
                    <strong class="text-primary">Sistema</strong>
                    <small class="text-muted ms-2">Ahora</small>
                </div>
                <div class="message-body mt-2">
                    ${resultHtml}
                </div>
            </div>
        </div>
    `;

    chatContainer.appendChild(messageDiv);
    scrollToBottom();
}

function formatMessage(content) {
    // Convert line breaks to <br>
    content = content.replace(/\n/g, '<br>');

    // Convert **bold** to <strong>
    content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

    // Convert *italic* to <em>
    content = content.replace(/\*(.*?)\*/g, '<em>$1</em>');

    // Convert code blocks
    content = content.replace(/```([\s\S]*?)```/g, '<div class="code-block">$1</div>');

    // Convert inline code
    content = content.replace(/`([^`]+)`/g, '<code>$1</code>');

    // Convert numbered lists
    content = content.replace(/(\d+)\.\s/g, '<br>$1. ');

    // Convert bullet points
    content = content.replace(/^\*\s/gm, '‚Ä¢ ');

    return content;
}

function showTypingIndicator() {
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message ai-message typing-indicator show';
    typingDiv.id = 'typingIndicator';
    typingDiv.innerHTML = `
        <div class="d-flex align-items-start">
            <div class="avatar ai-avatar me-3">
                <i class="fas fa-robot text-primary"></i>
            </div>
            <div class="message-content flex-grow-1">
                <div class="message-header">
                    <strong class="text-primary">AI Assistant</strong>
                </div>
                <div class="message-body mt-2">
                    <i class="fas fa-circle-notch fa-spin me-2"></i>Estoy pensando...
                </div>
            </div>
        </div>
    `;

    chatContainer.appendChild(typingDiv);
    scrollToBottom();
}

function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

function scrollToBottom() {
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function addOperationToPanel(title, details, type = 'info') {
    const operationsPanel = document.getElementById('operationsPanel');
    
    // Limpiar mensaje inicial si existe
    const emptyMessage = operationsPanel.querySelector('.text-muted.py-5');
    if (emptyMessage) {
        emptyMessage.remove();
    }
    
    const operationDiv = document.createElement('div');
    operationDiv.className = `operation-item ${type} mb-3`;
    
    const timestamp = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    
    let iconClass = 'fa-info-circle';
    let iconColor = 'text-info';
    
    if (type === 'success') {
        iconClass = 'fa-check-circle';
        iconColor = 'text-success';
    } else if (type === 'error') {
        iconClass = 'fa-times-circle';
        iconColor = 'text-danger';
    } else if (type === 'thinking') {
        iconClass = 'fa-brain';
        iconColor = 'text-warning';
    }
    
    operationDiv.innerHTML = `
        <div class="d-flex align-items-start mb-2">
            <i class="fas ${iconClass} ${iconColor} me-2 mt-1"></i>
            <div class="flex-grow-1">
                <div class="fw-bold">${title}</div>
                <small class="text-muted">${timestamp}</small>
            </div>
        </div>
        <div class="small text-muted">${details}</div>
    `;
    
    operationsPanel.appendChild(operationDiv);
    operationsPanel.scrollTop = operationsPanel.scrollHeight;
}

function clearChat() {
    if (confirm('¬øEst√°s seguro de que quieres limpiar todo el chat?')) {
        // Keep only the welcome message
        const welcomeMessage = chatContainer.querySelector('.message');
        chatContainer.innerHTML = '';
        if (welcomeMessage) {
            chatContainer.appendChild(welcomeMessage);
        }
        
        // Limpiar panel de operaciones
        const operationsPanel = document.getElementById('operationsPanel');
        operationsPanel.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="fas fa-brain fa-3x mb-3"></i>
                <p>Las operaciones de AWS aparecer√°n aqu√≠ mientras el AI trabaja...</p>
            </div>
        `;
    }
}

async function clearChatHistory() {
    if (confirm('¬øEst√°s seguro de que quieres iniciar una nueva conversaci√≥n? Se perder√° el contexto de la conversaci√≥n actual.')) {
        try {
            const response = await fetch('/chat/clear_history', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();
            
            if (data.status === 'success') {
                // Limpiar la interfaz visual
                chatContainer.innerHTML = `
                    <div class="message ai-message mb-3">
                        <div class="d-flex align-items-start">
                            <div class="avatar ai-avatar me-3">
                                <i class="fas fa-robot text-primary"></i>
                            </div>
                            <div class="message-content flex-grow-1">
                                <div class="message-header">
                                    <strong class="text-primary">AI Assistant</strong>
                                    <small class="text-muted ms-2">Ahora</small>
                                </div>
                                <div class="message-body mt-2">
                                    ¬°Hola! üëã Soy tu asistente de AWS con capacidad de ejecutar acciones reales. 
                                    Puedo ayudarte a crear, listar, detener y terminar instancias EC2, crear VPCs, 
                                    grupos de seguridad, buckets S3 y mucho m√°s. 
                                    <br><br>
                                    Dime qu√© necesitas y lo har√© por ti. Por ejemplo:
                                    <ul>
                                        <li>"Cr√©ame una instancia EC2 t2.micro para desarrollo"</li>
                                        <li>"Lista todas mis instancias EC2"</li>
                                        <li>"Crea un bucket S3 llamado mi-bucket-datos"</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Limpiar panel de operaciones
                const operationsPanel = document.getElementById('operationsPanel');
                operationsPanel.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-brain fa-3x mb-3"></i>
                        <p>Las operaciones de AWS aparecer√°n aqu√≠ mientras el AI trabaja...</p>
                    </div>
                `;
                
                // Mostrar notificaci√≥n
                alert('Nueva conversaci√≥n iniciada. El historial anterior se ha limpiado.');
            } else {
                alert('Error al limpiar el historial: ' + (data.error || 'Error desconocido'));
            }
        } catch (error) {
            console.error('Error clearing history:', error);
            alert('Error al limpiar el historial. Intenta de nuevo.');
        }
    }
}

// Focus on input when page loads
document.addEventListener('DOMContentLoaded', function() {
    messageInput.focus();
    
    // Agregar event listener para el bot√≥n de limpiar historial
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');
    if (clearHistoryBtn) {
        clearHistoryBtn.addEventListener('click', clearChatHistory);
    }

});
</script>
{% endblock %}