{% extends "base.html" %}

{% block title %}CloudFormation - Actualizar Stack{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="card-title mb-0">Actualizar Stack: {{ stack.stack_name }}</h2>
                        <small class="text-muted">Modificar la configuración del stack existente</small>
                    </div>
                    <div>
                        <a href="{{ url_for('cloudformation.stack_detail', stack_name=stack.stack_name) }}"
                           class="btn btn-outline-info">
                            <i class="fas fa-eye"></i> Ver Detalles
                        </a>
                        <a href="{{ url_for('cloudformation.stacks') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Volver a Stacks
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <!-- Información actual del stack -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Información del Stack Actual</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Estado:</strong>
                                <span class="badge
                                    {% if 'CREATE_COMPLETE' in stack.stack_status or 'UPDATE_COMPLETE' in stack.stack_status %}bg-success
                                    {% elif 'IN_PROGRESS' in stack.stack_status %}bg-primary
                                    {% elif 'FAILED' in stack.stack_status %}bg-danger
                                    {% else %}bg-secondary{% endif %}">
                                    {{ stack.stack_status }}
                                </span>
                            </div>
                            <div class="col-md-3">
                                <strong>Creado:</strong> {{ stack.creation_time.strftime('%Y-%m-%d %H:%M') }}
                            </div>
                            {% if stack.last_updated_time %}
                                <div class="col-md-3">
                                    <strong>Última actualización:</strong> {{ stack.last_updated_time.strftime('%Y-%m-%d %H:%M') }}
                                </div>
                            {% endif %}
                            <div class="col-md-3">
                                <strong>Descripción:</strong> {{ stack.description or 'Sin descripción' }}
                            </div>
                        </div>
                    </div>

                    <form method="POST" id="updateStackForm">
                        <div class="row">
                            <!-- Template para actualizar -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Nuevo Template</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert alert-warning">
                                            <small>
                                                <i class="fas fa-exclamation-triangle"></i>
                                                <strong>Importante:</strong> La actualización del stack solo modificará
                                                los recursos que cambien en el nuevo template. Los recursos sin cambios
                                                permanecerán igual.
                                            </small>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Template <span class="text-danger">*</span></label>
                                            <div class="mb-2">
                                                <input type="radio" class="btn-check" id="template_body_radio" name="template_source" value="body" autocomplete="off" checked>
                                                <label class="btn btn-outline-primary btn-sm" for="template_body_radio">Template Body</label>

                                                <input type="radio" class="btn-check" id="template_url_radio" name="template_source" value="url" autocomplete="off">
                                                <label class="btn btn-outline-primary btn-sm" for="template_url_radio">Template URL</label>
                                            </div>

                                            <div id="template_body_section">
                                                <textarea class="form-control" id="template_body" name="template_body"
                                                          rows="12" placeholder="Pegue aquí el template JSON/YAML actualizado..."></textarea>
                                                <div class="form-text">Template actualizado en formato JSON o YAML</div>
                                            </div>

                                            <div id="template_url_section" style="display: none;">
                                                <input type="url" class="form-control" id="template_url" name="template_url"
                                                       placeholder="https://s3.amazonaws.com/mi-bucket/template-v2.json">
                                                <div class="form-text">URL del template actualizado</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Parámetros actualizados -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Parámetros Actualizados</h5>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addParameter()">
                                            <i class="fas fa-plus"></i> Agregar Parámetro
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <!-- Parámetros actuales -->
                                        {% if stack.parameters %}
                                            <div class="mb-3">
                                                <h6>Parámetros Actuales:</h6>
                                                <div class="table-responsive">
                                                    <table class="table table-sm">
                                                        <thead>
                                                            <tr>
                                                                <th>Parámetro</th>
                                                                <th>Valor Actual</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for param in stack.parameters %}
                                                                <tr>
                                                                    <td><code>{{ param.parameter_key }}</code></td>
                                                                    <td>{{ param.parameter_value }}</td>
                                                                </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        {% endif %}

                                        <div id="parameters-container">
                                            <!-- Los parámetros nuevos se agregarán aquí dinámicamente -->
                                        </div>
                                        <div class="form-text">
                                            Solo incluye parámetros que quieras cambiar o agregar
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Opciones de actualización -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Opciones de Actualización</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>Tipos de Cambio</h6>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="change_set_type" id="update_with_changes" value="UPDATE_WITH_CHANGES" checked>
                                                    <label class="form-check-label" for="update_with_changes">
                                                        <strong>Actualización con Cambios</strong>
                                                        <br><small class="text-muted">Actualiza el stack con los cambios detectados</small>
                                                    </label>
                                                </div>
                                                <div class="form-check mt-2">
                                                    <input class="form-check-input" type="radio" name="change_set_type" id="update_replace" value="UPDATE_REPLACE">
                                                    <label class="form-check-label" for="update_replace">
                                                        <strong>Actualización con Reemplazo</strong>
                                                        <br><small class="text-muted">Reemplaza recursos cuando sea necesario</small>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Recomendaciones</h6>
                                                <div class="alert alert-info">
                                                    <ul class="mb-0 small">
                                                        <li><strong>Parámetros:</strong> Solo incluye los que cambian</li>
                                                        <li><strong>Template:</strong> Asegúrate de que sea válido</li>
                                                        <li><strong>Backup:</strong> Considera crear un backup antes</li>
                                                        <li><strong>Monitoreo:</strong> Revisa los eventos después de actualizar</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botones de acción -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-end gap-2">
                                    <a href="{{ url_for('cloudformation.stack_detail', stack_name=stack.stack_name) }}"
                                       class="btn btn-outline-secondary">
                                        <i class="fas fa-times"></i> Cancelar
                                    </a>
                                    <button type="submit" class="btn btn-warning">
                                        <i class="fas fa-edit"></i> Actualizar Stack
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Alternar entre template body y URL
document.querySelectorAll('input[name="template_source"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const templateBodySection = document.getElementById('template_body_section');
        const templateUrlSection = document.getElementById('template_url_section');

        if (this.value === 'body') {
            templateBodySection.style.display = 'block';
            templateUrlSection.style.display = 'none';
            document.getElementById('template_body').required = true;
            document.getElementById('template_url').required = false;
        } else {
            templateBodySection.style.display = 'none';
            templateUrlSection.style.display = 'block';
            document.getElementById('template_body').required = false;
            document.getElementById('template_url').required = true;
        }
    });
});

let parameterCount = 0;

function addParameter() {
    parameterCount++;
    const container = document.getElementById('parameters-container');
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.innerHTML = `
        <input type="text" class="form-control" name="param_key[]" placeholder="Nombre del parámetro" required>
        <input type="text" class="form-control" name="param_value[]" placeholder="Nuevo valor" required>
        <button type="button" class="btn btn-outline-danger" onclick="removeElement(this)">
            <i class="fas fa-trash"></i>
        </button>
    `;
    container.appendChild(div);
}

function removeElement(button) {
    button.closest('.input-group').remove();
}

// Validación del formulario
document.getElementById('updateStackForm').addEventListener('submit', function(e) {
    const templateSource = document.querySelector('input[name="template_source"]:checked').value;
    if (templateSource === 'body' && !document.getElementById('template_body').value.trim()) {
        e.preventDefault();
        alert('Debe proporcionar un template body.');
        return;
    }

    if (templateSource === 'url' && !document.getElementById('template_url').value.trim()) {
        e.preventDefault();
        alert('Debe proporcionar una URL del template.');
        return;
    }

    if (!confirm('¿Estás seguro de que quieres actualizar este stack? Esta acción puede modificar recursos existentes.')) {
        e.preventDefault();
        return;
    }

    // Mostrar indicador de carga
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando Stack...';
});
</script>
{% endblock %}