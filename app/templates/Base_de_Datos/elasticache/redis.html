<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clusters Redis - Amazon ElastiCache</title>
</head>
<body>
    {% extends "base.html" %}

    {% block content %}
    <div class="container-fluid mt-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Inicio</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('elasticache.index') }}">ElastiCache</a></li>
                <li class="breadcrumb-item active" aria-current="page">Clusters Redis</li>
            </ol>
        </nav>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h2><i class="fab fa-reddit text-danger me-2"></i>Clusters Redis</h2>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createClusterModal">
                            <i class="fas fa-plus me-2"></i>Crear Cluster Redis
                        </button>
                    </div>
                    <div class="card-body">
                        {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                            {% endfor %}
                        {% endif %}
                        {% endwith %}

                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID del Cluster</th>
                                        <th>Estado</th>
                                        <th>Versión del Motor</th>
                                        <th>Nodos</th>
                                        <th>Tipo de Nodo</th>
                                        <th>Endpoint</th>
                                        <th>Puerto</th>
                                        <th>Encriptado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cluster in clusters %}
                                    <tr>
                                        <td><strong>{{ cluster.cluster_id }}</strong></td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if cluster.status == 'available' else 'warning' if cluster.status == 'creating' else 'danger' }}">
                                                {{ cluster.status }}
                                            </span>
                                        </td>
                                        <td>{{ cluster.engine_version }}</td>
                                        <td>{{ cluster.num_cache_nodes }}</td>
                                        <td><code>{{ cluster.cache_node_type }}</code></td>
                                        <td><code>{{ cluster.endpoint or 'N/A' }}</code></td>
                                        <td>{{ cluster.port or 'N/A' }}</td>
                                        <td>
                                            {% if cluster.encryption %}
                                                <i class="fas fa-lock text-success"></i>
                                            {% else %}
                                                <i class="fas fa-unlock text-muted"></i>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <form method="POST" action="{{ url_for('elasticache.reboot_cluster', cluster_id=cluster.cluster_id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-sm btn-warning"
                                                            onclick="return confirm('¿Estás seguro de reiniciar el cluster {{ cluster.cluster_id }}?')">
                                                        <i class="fas fa-redo"></i> Reiniciar
                                                    </button>
                                                </form>
                                                <form method="POST" action="{{ url_for('elasticache.delete_cluster', cluster_id=cluster.cluster_id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-sm btn-danger ms-1"
                                                            onclick="return confirm('¿Estás seguro de eliminar el cluster {{ cluster.cluster_id }}? Esta acción no se puede deshacer.')">
                                                        <i class="fas fa-trash"></i> Eliminar
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    {% if not clusters %}
                                    <tr>
                                        <td colspan="9" class="text-center text-muted py-4">
                                            <i class="fab fa-reddit fa-2x text-danger mb-2"></i>
                                            <br>No hay clusters Redis configurados
                                        </td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Crear Cluster -->
    <div class="modal fade" id="createClusterModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fab fa-reddit text-danger me-2"></i>Crear Cluster Redis</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{{ url_for('elasticache.create_cluster') }}">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="clusterId" class="form-label">ID del Cluster *</label>
                                    <input type="text" class="form-control" id="clusterId" name="cluster_id" required
                                           placeholder="mi-cluster-redis">
                                    <div class="form-text">Identificador único para el cluster</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="cacheNodeType" class="form-label">Tipo de Nodo *</label>
                                    <select class="form-select" id="cacheNodeType" name="cache_node_type" required>
                                        <option value="cache.t3.micro">cache.t3.micro (0.5 GiB)</option>
                                        <option value="cache.t3.small">cache.t3.small (1.37 GiB)</option>
                                        <option value="cache.t3.medium" selected>cache.t3.medium (3.09 GiB)</option>
                                        <option value="cache.t4g.micro">cache.t4g.micro (0.5 GiB)</option>
                                        <option value="cache.t4g.small">cache.t4g.small (1.37 GiB)</option>
                                        <option value="cache.t4g.medium">cache.t4g.medium (3.09 GiB)</option>
                                        <option value="cache.m6g.large">cache.m6g.large (6.38 GiB)</option>
                                        <option value="cache.m6g.xlarge">cache.m6g.xlarge (12.87 GiB)</option>
                                        <option value="cache.m6g.2xlarge">cache.m6g.2xlarge (25.89 GiB)</option>
                                        <option value="cache.r6g.large">cache.r6g.large (13.07 GiB)</option>
                                        <option value="cache.r6g.xlarge">cache.r6g.xlarge (26.32 GiB)</option>
                                        <option value="cache.r6g.2xlarge">cache.r6g.2xlarge (52.82 GiB)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="engineVersion" class="form-label">Versión del Motor</label>
                                    <select class="form-select" id="engineVersion" name="engine_version">
                                        <option value="7.1" selected>Redis 7.1 (recomendado)</option>
                                        <option value="7.0">Redis 7.0</option>
                                        <option value="6.2">Redis 6.2</option>
                                        <option value="6.0">Redis 6.0</option>
                                        <option value="5.0.6">Redis 5.0.6</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="numCacheNodes" class="form-label">Número de Nodos</label>
                                    <select class="form-select" id="numCacheNodes" name="num_cache_nodes">
                                        <option value="1" selected>1 nodo</option>
                                        <option value="2">2 nodos</option>
                                        <option value="3">3 nodos</option>
                                        <option value="4">4 nodos</option>
                                        <option value="5">5 nodos</option>
                                        <option value="6">6 nodos</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="port" class="form-label">Puerto</label>
                                    <input type="number" class="form-control" id="port" name="port" value="6379" min="1024" max="65535">
                                    <div class="form-text">Puerto por defecto: 6379</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="parameterGroup" class="form-label">Grupo de Parámetros</label>
                                    <input type="text" class="form-control" id="parameterGroup" name="parameter_group_name"
                                           value="default.redis7.cluster.on" placeholder="default.redis7.cluster.on">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="encryption" name="encryption" checked>
                                <label class="form-check-label" for="encryption">
                                    Habilitar encriptación en tránsito
                                </label>
                            </div>
                        </div>
                        <input type="hidden" name="engine" value="redis">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fab fa-reddit me-2"></i>Crear Cluster Redis
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endblock %}
</body>
</html>